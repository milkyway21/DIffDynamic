# é¡¹ç›®è¿è¡Œå‡†å¤‡æ¸…å•

## âœ… å·²å…·å¤‡
- [x] é¡¹ç›®ä»£ç ç»“æ„å®Œæ•´
- [x] é…ç½®æ–‡ä»¶ï¼ˆ`configs/training.yml`, `configs/sampling.yml`ï¼‰
- [x] `data/affinity_info.pkl` æ–‡ä»¶

## âŒ éœ€è¦å‡†å¤‡

### 1. ç¯å¢ƒé…ç½®

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Condaï¼ˆæ¨èï¼‰
```bash
# åˆ›å»ºç¯å¢ƒ
conda create -n targetdiff python=3.8
conda activate targetdiff

# å®‰è£… PyTorch å’Œ CUDA
conda install pytorch pytorch-cuda=11.6 -c pytorch -c nvidia

# å®‰è£… PyTorch Geometric
conda install pyg -c pyg

# å®‰è£…å…¶ä»–ä¾èµ–
conda install rdkit openbabel tensorboard pyyaml easydict python-lmdb -c conda-forge

# å®‰è£… Vina ç›¸å…³ï¼ˆç”¨äºå¯¹æ¥è¯„ä¼°ï¼‰
pip install meeko==0.1.dev3 scipy pdb2pqr vina==1.2.2
python -m pip install git+https://github.com/Valdes-Tresanco-MS/AutoDockTools_py3
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨ Mambaï¼ˆæ›´å¿«ï¼‰
```bash
# å¦‚æœå·²å®‰è£… Mamba
mamba env create -f environment.yaml
conda activate targetdiff
```

### 2. æ•°æ®æ–‡ä»¶

#### å¿…éœ€æ•°æ®ï¼ˆç”¨äºè®­ç»ƒ/é‡‡æ ·ï¼‰
éœ€è¦ä» Google Drive ä¸‹è½½ï¼š
- **è®­ç»ƒæ•°æ®**ï¼š`crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb`
  - ä¸‹è½½é“¾æ¥ï¼šhttps://drive.google.com/drive/folders/1j21cc7-97TedKh_El5E34yI8o5ckI7eK?usp=share_link
  - æ”¾ç½®ä½ç½®ï¼š`./data/crossdocked_v1.1_rmsd1.0_pocket10/` æˆ–ç›´æ¥æ”¾åœ¨ `./data/` ç›®å½•ä¸‹

- **æ•°æ®åˆ’åˆ†æ–‡ä»¶**ï¼š`crossdocked_pocket10_pose_split.pt`
  - ä¸‹è½½é“¾æ¥ï¼šåŒä¸Š Google Drive
  - æ”¾ç½®ä½ç½®ï¼š`./data/crossdocked_pocket10_pose_split.pt`

- **æµ‹è¯•é›†**ï¼ˆå¯é€‰ï¼Œç”¨äºè¯„ä¼°ï¼‰ï¼š`test_set.zip`
  - ä¸‹è½½å¹¶è§£å‹åˆ°ï¼š`./data/test_set/`

#### æ›¿ä»£æ–¹æ¡ˆï¼šä»åŸå§‹æ•°æ®é¢„å¤„ç†
å¦‚æœæ— æ³•ä¸‹è½½é¢„å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä» CrossDocked2020 åŸå§‹æ•°æ®å¼€å§‹ï¼š
```bash
# 1. ä¸‹è½½ CrossDocked2020 v1.1 åˆ° data/CrossDocked2020
# ä¸‹è½½åœ°å€ï¼šhttps://bits.csb.pitt.edu/files/crossdock2020/

# 2. æ¸…æ´—æ•°æ®ï¼ˆä¿ç•™ RMSD < 1.0ï¼‰
python scripts/data_preparation/clean_crossdocked.py \
  --source data/CrossDocked2020 \
  --dest data/crossdocked_v1.1_rmsd1.0 \
  --rmsd_thr 1.0

# 3. æå–å£è¢‹ï¼ˆ10A åŒºåŸŸï¼‰
python scripts/data_preparation/extract_pockets.py \
  --source data/crossdocked_v1.1_rmsd1.0 \
  --dest data/crossdocked_v1.1_rmsd1.0_pocket10

# 4. åˆ’åˆ†æ•°æ®é›†
python scripts/data_preparation/split_pl_dataset.py \
  --path data/crossdocked_v1.1_rmsd1.0_pocket10 \
  --dest data/crossdocked_pocket10_pose_split.pt \
  --fixed_split data/split_by_name.pt  # éœ€è¦å…ˆä¸‹è½½ split_by_name.pt
```

### 3. é¢„è®­ç»ƒæ¨¡å‹

#### å¿…éœ€æ¨¡å‹ï¼ˆç”¨äºé‡‡æ ·/æ¨ç†ï¼‰
- **é¢„è®­ç»ƒæ‰©æ•£æ¨¡å‹**ï¼š`pretrained_diffusion.pt`
  - ä¸‹è½½é“¾æ¥ï¼šhttps://drive.google.com/drive/folders/1-ftaIrTXjWFhw3-0Twkrs5m0yX6CNarz?usp=share_link
  - æ”¾ç½®ä½ç½®ï¼š`./pretrained_models/pretrained_diffusion.pt`

#### å¯é€‰æ¨¡å‹ï¼ˆç”¨äºäº²å’ŒåŠ›é¢„æµ‹ï¼‰
- `egnn_pdbbind_v2016.pt`ï¼ˆå¦‚æœè¦åšäº²å’ŒåŠ›é¢„æµ‹ï¼‰

### 4. éªŒè¯å®‰è£…

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ç¯å¢ƒï¼š
```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}')"
python -c "import torch_geometric; print(f'PyG: {torch_geometric.__version__}')"
python -c "from rdkit import Chem; print('RDKit: OK')"
python -c "import openbabel; print('OpenBabel: OK')"
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åœºæ™¯ 1ï¼šä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œé‡‡æ ·ï¼ˆæ¨èæ–°æ‰‹ï¼‰

1. **ç¡®ä¿å·²ä¸‹è½½**ï¼š
   - âœ… é¢„è®­ç»ƒæ¨¡å‹ï¼š`pretrained_models/pretrained_diffusion.pt`
   - âœ… æ•°æ®åˆ’åˆ†æ–‡ä»¶ï¼š`data/crossdocked_pocket10_pose_split.pt`
   - âœ… æµ‹è¯•æ•°æ®æˆ–ç¤ºä¾‹å£è¢‹æ–‡ä»¶

2. **ä»ç¤ºä¾‹å£è¢‹é‡‡æ ·**ï¼š
```bash
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb \
  --device cuda:0 \
  --num_samples 100 \
  --result_path ./outputs/sample_1h36
```

3. **ä»æµ‹è¯•é›†é‡‡æ ·**ï¼š
```bash
python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id 0 \
  --device cuda:0 \
  --result_path ./outputs/test_case0
```

### åœºæ™¯ 2ï¼šä»å¤´è®­ç»ƒæ¨¡å‹

1. **ç¡®ä¿å·²ä¸‹è½½**ï¼š
   - âœ… è®­ç»ƒæ•°æ®ï¼š`data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb`
   - âœ… æ•°æ®åˆ’åˆ†ï¼š`data/crossdocked_pocket10_pose_split.pt`

2. **å¼€å§‹è®­ç»ƒ**ï¼š
```bash
python scripts/train_diffusion.py configs/training.yml \
  --device cuda:0 \
  --logdir ./logs_diffusion \
  --tag my_training_run
```

### åœºæ™¯ 3ï¼šè¯„ä¼°é‡‡æ ·ç»“æœ

```bash
python scripts/evaluate_diffusion.py ./outputs/sample_1h36 \
  --docking_mode vina_score \
  --protein_root data/test_set
```

## ğŸ“ é…ç½®æ–‡ä»¶æ£€æŸ¥

### `configs/training.yml`
- âœ… `data.path`: æŒ‡å‘è®­ç»ƒæ•°æ®è·¯å¾„
- âœ… `data.split`: æŒ‡å‘æ•°æ®åˆ’åˆ†æ–‡ä»¶

### `configs/sampling.yml`
- âœ… `model.checkpoint`: æŒ‡å‘é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ï¼ˆ`./pretrained_models/pretrained_diffusion.pt`ï¼‰

## âš ï¸ å¸¸è§é—®é¢˜

1. **CUDA ç‰ˆæœ¬ä¸åŒ¹é…**
   - æ£€æŸ¥ CUDA ç‰ˆæœ¬ï¼š`nvidia-smi`
   - æ ¹æ® CUDA ç‰ˆæœ¬å®‰è£…å¯¹åº”çš„ PyTorch

2. **æ•°æ®è·¯å¾„é”™è¯¯**
   - ç¡®ä¿ `configs/training.yml` ä¸­çš„ `data.path` å’Œ `data.split` è·¯å¾„æ­£ç¡®
   - ç¡®ä¿ `configs/sampling.yml` ä¸­çš„ `model.checkpoint` è·¯å¾„æ­£ç¡®

3. **æ˜¾å­˜ä¸è¶³**
   - å‡å° `batch_size`ï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
   - ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯ï¼ˆ`n_acc_batch`ï¼‰

4. **Windows å¹³å°ç‰¹æ®Šé—®é¢˜**
   - OpenBabel å¯èƒ½éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ° PATH
   - æŸäº›è„šæœ¬å¯èƒ½éœ€è¦ä¿®æ”¹è·¯å¾„åˆ†éš”ç¬¦

## ğŸ“š æ›´å¤šä¿¡æ¯

- è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼š`MODEL_USAGE_GUIDE.md`
- é¡¹ç›®è¯´æ˜ï¼š`README.md`
- æ‰§è¡Œæµç¨‹ï¼š`æ‰§è¡Œæµç¨‹æŠ¥å‘Š.md`

