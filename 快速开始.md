# DiffDynamic é¡¹ç›®å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šè¿è¡Œç¯å¢ƒæ£€æŸ¥

```bash
python check_requirements.py
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- Python ç‰ˆæœ¬å’Œä¾èµ–åŒ…
- å¿…éœ€çš„æ•°æ®æ–‡ä»¶
- é¢„è®­ç»ƒæ¨¡å‹
- é…ç½®æ–‡ä»¶

## ğŸš€ ç¬¬äºŒæ­¥ï¼šæ ¹æ®æ£€æŸ¥ç»“æœå‡†å¤‡ç¯å¢ƒ

### å¦‚æœç¼ºå°‘Pythonä¾èµ–

#### é€‰é¡¹1ï¼šä½¿ç”¨ Condaï¼ˆæ¨èï¼‰
```bash
# åˆ›å»ºç¯å¢ƒ
conda create -n targetdiff python=3.8
conda activate targetdiff

# å®‰è£… PyTorchï¼ˆæ ¹æ®ä½ çš„CUDAç‰ˆæœ¬é€‰æ‹©ï¼‰
conda install pytorch pytorch-cuda=11.6 -c pytorch -c nvidia
# æˆ–è€… CUDA 11.8
# conda install pytorch pytorch-cuda=11.8 -c pytorch -c nvidia

# å®‰è£… PyTorch Geometric
conda install pyg -c pyg

# å®‰è£…å…¶ä»–ä¾èµ–
conda install rdkit openbabel tensorboard pyyaml easydict python-lmdb -c conda-forge

# å®‰è£… Vina ç›¸å…³ï¼ˆå¯é€‰ï¼Œç”¨äºå¯¹æ¥è¯„ä¼°ï¼‰
pip install meeko==0.1.dev3 scipy pdb2pqr vina==1.2.2
python -m pip install git+https://github.com/Valdes-Tresanco-MS/AutoDockTools_py3
```

#### é€‰é¡¹2ï¼šä½¿ç”¨ Mambaï¼ˆæ›´å¿«ï¼‰
```bash
mamba env create -f environment.yaml
conda activate targetdiff
```

### å¦‚æœç¼ºå°‘æ•°æ®æ–‡ä»¶

#### å¿…éœ€æ–‡ä»¶ä¸‹è½½ï¼ˆGoogle Driveï¼‰
1. **æ•°æ®åˆ’åˆ†æ–‡ä»¶**ï¼ˆå¿…éœ€ï¼‰
   - æ–‡ä»¶åï¼š`crossdocked_pocket10_pose_split.pt`
   - ä¸‹è½½é“¾æ¥ï¼šhttps://drive.google.com/drive/folders/1j21cc7-97TedKh_El5E34yI8o5ckI7eK?usp=share_link
   - æ”¾ç½®ä½ç½®ï¼š`./data/crossdocked_pocket10_pose_split.pt`

2. **è®­ç»ƒæ•°æ®**ï¼ˆå¦‚æœè¦ä»å¤´è®­ç»ƒï¼‰
   - æ–‡ä»¶åï¼š`crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb`
   - ä¸‹è½½é“¾æ¥ï¼šåŒä¸Š
   - æ”¾ç½®ä½ç½®ï¼š`./data/` ç›®å½•ä¸‹

### å¦‚æœç¼ºå°‘é¢„è®­ç»ƒæ¨¡å‹

#### é¢„è®­ç»ƒæ¨¡å‹ä¸‹è½½ï¼ˆå¿…éœ€ï¼Œç”¨äºé‡‡æ ·ï¼‰
- æ–‡ä»¶åï¼š`pretrained_diffusion.pt`
- ä¸‹è½½é“¾æ¥ï¼šhttps://drive.google.com/drive/folders/1-ftaIrTXjWFhw3-0Twkrs5m0yX6CNarz?usp=share_link
- æ”¾ç½®ä½ç½®ï¼š`./pretrained_models/pretrained_diffusion.pt`

## ğŸ¯ ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹ä½¿ç”¨

### åœºæ™¯Aï¼šå¿«é€Ÿæµ‹è¯•ï¼ˆä½¿ç”¨ç¤ºä¾‹æ–‡ä»¶ï¼‰

å¦‚æœåªæƒ³å¿«é€Ÿæµ‹è¯•é¡¹ç›®æ˜¯å¦èƒ½è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„ç¤ºä¾‹æ–‡ä»¶ï¼š

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff

# ä½¿ç”¨ç¤ºä¾‹å£è¢‹è¿›è¡Œé‡‡æ ·
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb \
  --device cuda:0 \
  --num_samples 32 \
  --result_path ./outputs/test_sample
```

**æ³¨æ„**ï¼šè¿™éœ€è¦é¢„è®­ç»ƒæ¨¡å‹ `pretrained_models/pretrained_diffusion.pt`

### åœºæ™¯Bï¼šä»æµ‹è¯•é›†é‡‡æ ·

```bash
python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id 0 \
  --device cuda:0 \
  --result_path ./outputs/test_case0
```

**æ³¨æ„**ï¼šè¿™éœ€è¦ï¼š
- é¢„è®­ç»ƒæ¨¡å‹
- æ•°æ®åˆ’åˆ†æ–‡ä»¶ `data/crossdocked_pocket10_pose_split.pt`
- è®­ç»ƒæ•°æ®ï¼ˆç”¨äºåŠ è½½æµ‹è¯•é›†ï¼‰

### åœºæ™¯Cï¼šä»å¤´è®­ç»ƒ

```bash
python scripts/train_diffusion.py configs/training.yml \
  --device cuda:0 \
  --logdir ./logs_diffusion \
  --tag my_first_training
```

**æ³¨æ„**ï¼šè¿™éœ€è¦ï¼š
- è®­ç»ƒæ•°æ®ï¼ˆLMDBæ–‡ä»¶æˆ–åŸå§‹æ•°æ®ç›®å½•ï¼‰
- æ•°æ®åˆ’åˆ†æ–‡ä»¶

## âš™ï¸ é…ç½®è¯´æ˜

### ä¿®æ”¹é‡‡æ ·é…ç½®ï¼ˆ`configs/sampling.yml`ï¼‰

å¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥å‡å°æ‰¹é‡å¤§å°ï¼š
```yaml
sample:
  dynamic:
    large_step:
      batch_size: 16  # ä»32å‡å°åˆ°16
    refine:
      n_sampling: 2  # ä»3å‡å°åˆ°2
```

### ä¿®æ”¹è®­ç»ƒé…ç½®ï¼ˆ`configs/training.yml`ï¼‰

å¦‚æœæ˜¾å­˜ä¸è¶³ï¼š
```yaml
train:
  batch_size: 2  # ä»4å‡å°åˆ°2
  n_acc_batch: 2  # å¢åŠ æ¢¯åº¦ç´¯ç§¯æ¬¡æ•°
```

## ğŸ” éªŒè¯å®‰è£…

è¿è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯å…³é”®åŒ…ï¼š

```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDAå¯ç”¨: {torch.cuda.is_available()}')"
python -c "import torch_geometric; print(f'PyG: {torch_geometric.__version__}')"
python -c "from rdkit import Chem; print('RDKit: OK')"
```

## ğŸ“ å¸¸è§é—®é¢˜

### 1. CUDA ä¸å¯ç”¨
- æ£€æŸ¥ NVIDIA é©±åŠ¨ï¼š`nvidia-smi`
- æ£€æŸ¥ PyTorch CUDA ç‰ˆæœ¬ï¼š`python -c "import torch; print(torch.version.cuda)"`
- ç¡®ä¿ PyTorch çš„ CUDA ç‰ˆæœ¬ä¸ç³»ç»Ÿ CUDA ç‰ˆæœ¬å…¼å®¹

### 2. æ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰
- å‡å° `batch_size`
- å‡å° `sample.dynamic.large_step.batch_size`
- ä½¿ç”¨ CPUï¼ˆä¸æ¨èï¼Œä¼šå¾ˆæ…¢ï¼‰ï¼š`--device cpu`

### 3. æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶
- æ£€æŸ¥ `configs/training.yml` ä¸­çš„ `data.path` å’Œ `data.split` è·¯å¾„
- ç¡®ä¿è·¯å¾„ä½¿ç”¨æ­£æ–œæ  `/` æˆ–åŒåæ–œæ  `\\`ï¼ˆWindowsï¼‰

### 4. æ‰¾ä¸åˆ°é¢„è®­ç»ƒæ¨¡å‹
- æ£€æŸ¥ `configs/sampling.yml` ä¸­çš„ `model.checkpoint` è·¯å¾„
- ç¡®ä¿æ–‡ä»¶å·²ä¸‹è½½åˆ°æ­£ç¡®ä½ç½®

## ğŸ“š æ›´å¤šèµ„æº

- è¯¦ç»†å‡†å¤‡æ¸…å•ï¼š`è¿è¡Œå‡†å¤‡æ¸…å•.md`
- æ¨¡å‹ä½¿ç”¨æŒ‡å—ï¼š`MODEL_USAGE_GUIDE.md`
- é¡¹ç›®READMEï¼š`README.md`

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. å…ˆè¿è¡Œ `python check_requirements.py` æ£€æŸ¥ç¯å¢ƒ
2. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œç¡®è®¤ç¼ºå°‘çš„æ–‡ä»¶æˆ–ä¾èµ–
3. å‚è€ƒ `è¿è¡Œå‡†å¤‡æ¸…å•.md` ä¸­çš„è¯¦ç»†è¯´æ˜

