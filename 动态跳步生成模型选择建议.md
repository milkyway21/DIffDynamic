# åŠ¨æ€è·³æ­¥ç”Ÿæˆï¼šæ¨¡å‹é€‰æ‹©å»ºè®®

## ğŸ“Š æ ¸å¿ƒç»“è®º

**å¯¹äºåŠ¨æ€è·³æ­¥ç”Ÿæˆï¼Œå»ºè®®ä½¿ç”¨ TargetDiff çš„é¢„è®­ç»ƒæ¨¡å‹**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. âœ… **åŠ¨æ€é‡‡æ ·åŠŸèƒ½å·²å®Œæ•´å®ç°**ï¼š`ScorePosNet3D` ä¸­å·²åŒ…å«å®Œæ•´çš„åŠ¨æ€è·³æ­¥é‡‡æ ·åŠŸèƒ½
2. âœ… **é¢„è®­ç»ƒæ¨¡å‹å¯ç›´æ¥ä½¿ç”¨**ï¼šTargetDiff å®˜æ–¹æä¾›çš„é¢„è®­ç»ƒæ¨¡å‹å¯ä»¥ç›´æ¥ç”¨äºåŠ¨æ€é‡‡æ ·
3. âœ… **æ— éœ€é¢å¤–è®­ç»ƒ**ï¼šç›´æ¥ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹å³å¯ï¼Œæ— éœ€é‡æ–°è®­ç»ƒ
4. âš ï¸ **GlintDM é¢„è®­ç»ƒæ¨¡å‹å¯èƒ½ä¸å­˜åœ¨**ï¼šç›®å‰æ²¡æœ‰å…¬å¼€çš„ GlintDM é¢„è®­ç»ƒæ¨¡å‹

## ğŸ” æŠ€æœ¯åˆ†æ

### ä¸¤ç§æ¨¡å‹çš„åŠ¨æ€é‡‡æ ·æ”¯æŒ

#### 1. ScorePosNet3Dï¼ˆTargetDiff åŸå§‹æ¨¡å‹ï¼‰
- âœ… å·²å®ç° `dynamic_sample_diffusion` æ–¹æ³•
- âœ… å·²å®ç° `sample_diffusion_large_step`ï¼ˆå¤§æ­¥æ¢ç´¢ï¼‰
- âœ… å·²å®ç° `sample_diffusion_refinement`ï¼ˆç²¾ç‚¼é‡‡æ ·ï¼‰
- âœ… æ”¯æŒåŠ¨æ€è·³æ­¥ç”Ÿæˆæµç¨‹
- ğŸ“ é»˜è®¤ä½¿ç”¨ `ligand_v_input='onehot'`

#### 2. GlintDMï¼ˆå¢å¼ºç‰ˆæ¨¡å‹ï¼‰
- âœ… ç»§æ‰¿è‡ª `ScorePosNet3D`ï¼ŒåŒ…å«æ‰€æœ‰åŠ¨æ€é‡‡æ ·åŠŸèƒ½
- âœ… é¢å¤–åŠŸèƒ½ï¼šæ¢¯åº¦èåˆã€log_prob è¾“å…¥æ¨¡å¼
- âœ… åœ¨ç²¾ç‚¼é˜¶æ®µä½¿ç”¨ `_with_noise` æ–¹æ³•ï¼ˆæ›´å¹³æ»‘ï¼‰
- ğŸ“ é»˜è®¤ä½¿ç”¨ `ligand_v_input='log_prob'` å’Œ `use_grad_fusion=True`
- âš ï¸ **éœ€è¦ä¸“é—¨çš„ GlintDM é¢„è®­ç»ƒæ¨¡å‹**ï¼ˆç›®å‰å¯èƒ½ä¸å­˜åœ¨ï¼‰

### å…³é”®ä»£ç ä½ç½®

åŠ¨æ€é‡‡æ ·åŠŸèƒ½åœ¨ `models/molopt_score_model.py` ä¸­å®ç°ï¼š
- `dynamic_sample_diffusion` (ç¬¬ 1282 è¡Œ)ï¼šç»Ÿä¸€åŠ¨æ€é‡‡æ ·æ¥å£
- `sample_diffusion_large_step` (ç¬¬ 991 è¡Œ)ï¼šå¤§æ­¥æ¢ç´¢é˜¶æ®µ
- `sample_diffusion_refinement` (ç¬¬ 1072 è¡Œ)ï¼šç²¾ç‚¼é‡‡æ ·é˜¶æ®µ

**ä¸¤ç§æ¨¡å‹éƒ½åŒ…å«è¿™äº›æ–¹æ³•**ï¼Œå› æ­¤éƒ½æ”¯æŒåŠ¨æ€è·³æ­¥ç”Ÿæˆã€‚

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ–¹æ¡ˆAï¼šä½¿ç”¨ TargetDiff é¢„è®­ç»ƒæ¨¡å‹ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹å¯ç›´æ¥ä¸‹è½½ä½¿ç”¨
- âœ… åŠ¨æ€é‡‡æ ·åŠŸèƒ½å®Œæ•´
- âœ… æ— éœ€è®­ç»ƒï¼Œå¼€ç®±å³ç”¨

**é…ç½®**ï¼š
```yaml
# configs/sampling.yml
model:
  checkpoint: ./pretrained_models/pretrained_diffusion.pt
  # æ¨¡å‹ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º ScorePosNet3Dï¼ˆå› ä¸º checkpoint ä¸­ model.name != 'glintdm'ï¼‰

sample:
  mode: dynamic  # ä½¿ç”¨åŠ¨æ€é‡‡æ ·æ¨¡å¼
  dynamic:
    large_step:
      batch_size: 32
      stride: 50
      step_size: 1.0
      n_repeat: 4
    refine:
      stride: 10
      step_size: 0.2
      time_upper: 500
      n_sampling: 3
```

**è¿è¡Œå‘½ä»¤**ï¼š
```bash
python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id 0 \
  --device cuda:0 \
  --mode dynamic \
  --result_path ./outputs/dynamic_sample
```

### æ–¹æ¡ˆBï¼šä½¿ç”¨ GlintDM é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

**å‰ææ¡ä»¶**ï¼š
- éœ€è¦æœ‰ GlintDM çš„é¢„è®­ç»ƒæ¨¡å‹
- æ¨¡å‹å¿…é¡»æ˜¯ç”¨ GlintDM è®­ç»ƒçš„ï¼ˆ`model.name='glintdm'`ï¼‰

**é…ç½®**ï¼š
```yaml
# configs/sampling.yml
model:
  checkpoint: ./pretrained_models/glintdm_pretrained.pt
  # checkpoint ä¸­åº”åŒ…å« model.name='glintdm'

sample:
  mode: dynamic
  # ... å…¶ä»–é…ç½®åŒä¸Š
```

**ä¼˜ç‚¹**ï¼ˆå¦‚æœæ¨¡å‹å­˜åœ¨ï¼‰ï¼š
- âœ… å¯èƒ½æä¾›æ›´å¥½çš„é‡‡æ ·è´¨é‡ï¼ˆæ¢¯åº¦èåˆã€log_prob è¾“å…¥ï¼‰
- âœ… ç²¾ç‚¼é˜¶æ®µä½¿ç”¨ `_with_noise` æ–¹æ³•ï¼Œåˆ†å¸ƒæ›´å¹³æ»‘

**ç¼ºç‚¹**ï¼š
- âŒ ç›®å‰å¯èƒ½æ²¡æœ‰å…¬å¼€çš„ GlintDM é¢„è®­ç»ƒæ¨¡å‹
- âŒ éœ€è¦ç¡®è®¤æ¨¡å‹æ˜¯å¦ä¸å½“å‰ä»£ç å…¼å®¹

## ğŸ”§ æ¨¡å‹è‡ªåŠ¨è¯†åˆ«æœºåˆ¶

ä»£ç ä¼šæ ¹æ® checkpoint ä¸­çš„é…ç½®è‡ªåŠ¨é€‰æ‹©æ¨¡å‹ç±»å‹ï¼š

```python
# scripts/sample_diffusion.py ç¬¬ 656-657 è¡Œ
model_name = getattr(model_cfg, 'name', 'score').lower()
model_cls = GlintDM if model_name == 'glintdm' else ScorePosNet3D
```

**è¿™æ„å‘³ç€**ï¼š
- å¦‚æœ checkpoint ä¸­ `model.name == 'glintdm'`ï¼Œä¼šä½¿ç”¨ `GlintDM`
- å¦åˆ™ï¼Œä¼šä½¿ç”¨ `ScorePosNet3D`ï¼ˆTargetDiff åŸå§‹æ¨¡å‹ï¼‰

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨ä½¿ç”¨åŠ¨æ€è·³æ­¥ç”Ÿæˆå‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²ä¸‹è½½ TargetDiff é¢„è®­ç»ƒæ¨¡å‹ï¼š`pretrained_models/pretrained_diffusion.pt`
- [ ] é…ç½®æ–‡ä»¶ `configs/sampling.yml` ä¸­ `sample.mode = dynamic`
- [ ] å·²è®¾ç½®åŠ¨æ€é‡‡æ ·å‚æ•°ï¼ˆ`sample.dynamic.*`ï¼‰
- [ ] å·²å‡†å¤‡æ•°æ®æ–‡ä»¶ï¼ˆå¦‚æœä»æµ‹è¯•é›†é‡‡æ ·ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹
ä» Google Drive ä¸‹è½½ TargetDiff é¢„è®­ç»ƒæ¨¡å‹ï¼š
- é“¾æ¥ï¼šhttps://drive.google.com/drive/folders/1-ftaIrTXjWFhw3-0Twkrs5m0yX6CNarz?usp=share_link
- æ–‡ä»¶åï¼š`pretrained_diffusion.pt`
- ä¿å­˜ä½ç½®ï¼š`./pretrained_models/pretrained_diffusion.pt`

### 2. ä½¿ç”¨ç¤ºä¾‹æ–‡ä»¶æµ‹è¯•
```bash
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb \
  --device cuda:0 \
  --num_samples 32 \
  --result_path ./outputs/dynamic_test
```

### 3. ä»æµ‹è¯•é›†é‡‡æ ·
```bash
python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id 0 \
  --device cuda:0 \
  --mode dynamic \
  --result_path ./outputs/dynamic_case0
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡å‹å…¼å®¹æ€§**ï¼š
   - TargetDiff é¢„è®­ç»ƒæ¨¡å‹ä½¿ç”¨ `onehot` è¾“å…¥æ¨¡å¼
   - åŠ¨æ€é‡‡æ ·ä¼šè‡ªåŠ¨å¤„ç†è¾“å…¥æ ¼å¼è½¬æ¢
   - æ— éœ€ä¿®æ”¹æ¨¡å‹é…ç½®

2. **æ€§èƒ½å·®å¼‚**ï¼š
   - TargetDiff æ¨¡å‹ï¼šæ ‡å‡†åŠ¨æ€é‡‡æ ·ï¼Œæ€§èƒ½ç¨³å®š
   - GlintDM æ¨¡å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼šå¯èƒ½æä¾›æ›´å¥½çš„é‡‡æ ·è´¨é‡ï¼Œä½†éœ€è¦ä¸“é—¨çš„é¢„è®­ç»ƒæ¨¡å‹

3. **é…ç½®å»ºè®®**ï¼š
   - å¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå‡å° `sample.dynamic.large_step.batch_size`
   - å¦‚æœé‡‡æ ·è´¨é‡ä¸å¤Ÿï¼Œå¯ä»¥è°ƒæ•´ `step_size` å’Œ `stride` å‚æ•°

## ğŸ“š ç›¸å…³æ–‡æ¡£

- æ¨¡å‹ä½¿ç”¨æŒ‡å—ï¼š`MODEL_USAGE_GUIDE.md`
- è¿è¡Œå‡†å¤‡æ¸…å•ï¼š`è¿è¡Œå‡†å¤‡æ¸…å•.md`
- å¿«é€Ÿå¼€å§‹ï¼š`å¿«é€Ÿå¼€å§‹.md`

## ğŸ’¡ æ€»ç»“

**æ¨èä½¿ç”¨ TargetDiff çš„é¢„è®­ç»ƒæ¨¡å‹**ï¼Œå› ä¸ºï¼š
1. âœ… åŠ¨æ€é‡‡æ ·åŠŸèƒ½å·²å®Œæ•´å®ç°
2. âœ… é¢„è®­ç»ƒæ¨¡å‹å¯ç›´æ¥ä¸‹è½½ä½¿ç”¨
3. âœ… æ— éœ€é¢å¤–è®­ç»ƒæˆ–é…ç½®
4. âœ… å¼€ç®±å³ç”¨ï¼Œç¨³å®šå¯é 

å¦‚æœæœªæ¥æœ‰ GlintDM çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä»¥è·å¾—æ›´å¥½çš„é‡‡æ ·è´¨é‡ï¼Œä½†ç›®å‰ TargetDiff æ¨¡å‹å·²ç»è¶³å¤Ÿä½¿ç”¨ã€‚

