# å›ºå®šè›‹ç™½è´¨å£è¢‹é‡‡æ ·æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜Žå¦‚ä½•ä½¿ç”¨å›ºå®šçš„è›‹ç™½è´¨å£è¢‹ç”Ÿæˆåˆ†å­ã€‚

---

## ðŸ“‹ ä¸¤ç§æ–¹å¼

### æ–¹å¼ä¸€ï¼šä»Žæµ‹è¯•é›†é‡‡æ ·ï¼ˆæŽ¨èï¼‰

å¦‚æžœæ‚¨çš„æµ‹è¯•é›†ä¸­æœ‰ç´¢å¼•ä¸º 5 çš„æ ·æœ¬ï¼Œå¯ä»¥ç›´æŽ¥ä½¿ç”¨ `sample_diffusion.py`ï¼š

```bash
# åœ¨ WSL ä¸­æ‰§è¡Œ
cd /mnt/d/DiffDynamic
conda activate targetdiff

# ä½¿ç”¨æµ‹è¯•é›†ç´¢å¼• 5 è¿›è¡Œé‡‡æ ·
python scripts/sample_diffusion.py configs/sampling.yml --data_id 5 --device cuda:0 --mode dynamic --result_path ./outputs/pocket5_samples
```

**å‚æ•°è¯´æ˜Žï¼š**
- `--data_id 5`: ä½¿ç”¨æµ‹è¯•é›†ä¸­ç´¢å¼•ä¸º 5 çš„è›‹ç™½è´¨å£è¢‹
- `--mode dynamic`: ä½¿ç”¨åŠ¨æ€é‡‡æ ·æ¨¡å¼ï¼ˆç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼‰
- `--result_path`: ç»“æžœä¿å­˜è·¯å¾„

**ç»“æžœæ–‡ä»¶ï¼š**
- `outputs/pocket5_samples/result_5.pt`: é‡‡æ ·ç»“æžœï¼ˆPyTorch æ ¼å¼ï¼‰
- `outputs/pocket5_samples/sample.yml`: é…ç½®æ–‡ä»¶å¤‡ä»½

---

### æ–¹å¼äºŒï¼šä»Ž PDB æ–‡ä»¶é‡‡æ ·

å¦‚æžœæ‚¨æœ‰ç‰¹å®šçš„ PDB æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `sample_for_pocket.py`ï¼š

```bash
# åœ¨ WSL ä¸­æ‰§è¡Œ
cd /mnt/d/DiffDynamic
conda activate targetdiff

# ä½¿ç”¨ PDB æ–‡ä»¶è¿›è¡Œé‡‡æ ·
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path /path/to/your/pocket5.pdb \
  --device cuda:0 \
  --num_samples 100 \
  --result_path ./outputs/pocket5_pdb_samples
```

**å‚æ•°è¯´æ˜Žï¼š**
- `--pdb_path`: PDB æ–‡ä»¶è·¯å¾„ï¼ˆå¿…é¡»æ˜¯å£è¢‹æ–‡ä»¶ï¼Œ10A åŒºåŸŸï¼‰
- `--num_samples 100`: ç”Ÿæˆ 100 ä¸ªåˆ†å­æ ·æœ¬
- `--mode dynamic`: å¯é€‰ï¼Œå¦‚æžœä¸æŒ‡å®šåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å¼

**ç»“æžœæ–‡ä»¶ï¼š**
- `outputs/pocket5_pdb_samples/result.pt`: é‡‡æ ·ç»“æžœ
- `outputs/pocket5_pdb_samples/sample_*.sdf`: é‡å»ºçš„åˆ†å­æ–‡ä»¶ï¼ˆSDF æ ¼å¼ï¼‰
- `outputs/pocket5_pdb_samples/sample.yml`: é…ç½®æ–‡ä»¶å¤‡ä»½

---

## ðŸ” å¦‚ä½•æ‰¾åˆ°æµ‹è¯•é›†ä¸­çš„å£è¢‹ 5

å¦‚æžœæ‚¨æƒ³æŸ¥çœ‹æµ‹è¯•é›†ä¸­ç´¢å¼• 5 å¯¹åº”çš„æ˜¯å“ªä¸ªè›‹ç™½è´¨å£è¢‹ï¼š

```bash
# åœ¨ Python ä¸­æŸ¥çœ‹
python -c "
import torch
from datasets import get_dataset
import utils.transforms as trans
from torch_geometric.transforms import Compose

# åŠ è½½æ£€æŸ¥ç‚¹èŽ·å–é…ç½®
ckpt = torch.load('pretrained_models/pretrained_diffusion.pt', map_location='cpu')
config = ckpt['config']

# åˆ›å»ºè½¬æ¢å™¨
protein_featurizer = trans.FeaturizeProteinAtom()
ligand_atom_mode = config.data.transform.ligand_atom_mode
ligand_featurizer = trans.FeaturizeLigandAtom(ligand_atom_mode)
transform = Compose([
    protein_featurizer,
    ligand_featurizer,
    trans.FeaturizeLigandBond(),
])

# åŠ è½½æ•°æ®é›†
from datasets import get_dataset
dataset, subsets = get_dataset(config=config.data, transform=transform)
train_set, test_set = subsets['train'], subsets['test']

# æŸ¥çœ‹ç´¢å¼• 5 çš„ä¿¡æ¯
data = test_set[5]
print(f'ç´¢å¼• 5 çš„è›‹ç™½è´¨æ–‡ä»¶: {getattr(data, \"protein_filename\", \"æœªçŸ¥\")}')
print(f'ç´¢å¼• 5 çš„é…ä½“æ–‡ä»¶: {getattr(data, \"ligand_filename\", \"æœªçŸ¥\")}')
print(f'è›‹ç™½è´¨åŽŸå­æ•°: {data.protein_pos.shape[0]}')
"
```

---

## ðŸ“ å®Œæ•´ç¤ºä¾‹å‘½ä»¤

### ç¤ºä¾‹ 1ï¼šä»Žæµ‹è¯•é›†é‡‡æ ·ï¼ˆç”Ÿæˆ 100 ä¸ªåˆ†å­ï¼‰

```bash
python scripts/sample_diffusion.py configs/sampling.yml --data_id 5 --device cuda:0 --mode dynamic --result_path ./outputs/pocket5_100samples
```

**æ³¨æ„ï¼š** ç”Ÿæˆæ•°é‡ç”± `configs/sampling.yml` ä¸­çš„ `num_samples` æŽ§åˆ¶ï¼ˆé»˜è®¤ 100ï¼‰

### ç¤ºä¾‹ 2ï¼šä»Ž PDB æ–‡ä»¶é‡‡æ ·ï¼ˆç”Ÿæˆ 50 ä¸ªåˆ†å­ï¼‰

```bash
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb \
  --device cuda:0 \
  --num_samples 50 \
  --result_path ./outputs/pocket5_50samples
```

### ç¤ºä¾‹ 3ï¼šä½¿ç”¨ CPUï¼ˆå¦‚æžœæ²¡æœ‰ GPUï¼‰

```bash
python scripts/sample_diffusion.py configs/sampling.yml --data_id 5 --device cpu --mode dynamic --result_path ./outputs/pocket5_cpu
```

**æ³¨æ„ï¼š** CPU æ¨¡å¼ä¼šå¾ˆæ…¢ï¼Œå»ºè®®ä½¿ç”¨ GPU

---

## âš™ï¸ è‡ªå®šä¹‰é‡‡æ ·å‚æ•°

### ä¿®æ”¹ç”Ÿæˆæ•°é‡

**æ–¹å¼ä¸€ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶**

ç¼–è¾‘ `configs/sampling.yml`ï¼š
```yaml
sample:
  num_samples: 200  # æ”¹ä¸º 200 ä¸ªæ ·æœ¬
```

**æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œå‚æ•°ï¼ˆä»… `sample_for_pocket.py` æ”¯æŒï¼‰**

```bash
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path your_pocket.pdb \
  --num_samples 200 \
  --device cuda:0 \
  --result_path ./outputs/pocket5_200samples
```

### ä¿®æ”¹æ˜¾å­˜ä¼˜åŒ–å‚æ•°

å¦‚æžœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥ä¿®æ”¹ `configs/sampling.yml`ï¼š

```yaml
sample:
  dynamic:
    large_step:
      batch_size: 8  # ä»Ž 16 å‡å°åˆ° 8
    refine:
      n_sampling: 1  # ä»Ž 2 å‡å°åˆ° 1
    selector:
      top_n: 6  # ä»Ž 12 å‡å°åˆ° 6
```

---

## ðŸ“Š æŸ¥çœ‹ç»“æžœ

### æŸ¥çœ‹é‡‡æ ·ç»“æžœç»Ÿè®¡

```bash
python -c "
import torch
result = torch.load('outputs/pocket5_samples/result_5.pt')
print(f'é‡‡æ ·æ¨¡å¼: {result.get(\"mode\", \"unknown\")}')
print(f'ç”Ÿæˆæ ·æœ¬æ•°: {len(result[\"pred_ligand_pos\"])}')
print(f'å¹³å‡é‡‡æ ·æ—¶é—´: {sum(result[\"time\"]) / len(result[\"time\"]):.2f} ç§’')
if 'meta' in result:
    print(f'å…ƒæ•°æ®: {result[\"meta\"]}')
"
```

### æŸ¥çœ‹ç”Ÿæˆçš„ SDF æ–‡ä»¶ï¼ˆä»… PDB æ–‡ä»¶é‡‡æ ·ï¼‰

```bash
# åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„åˆ†å­æ–‡ä»¶
ls -lh outputs/pocket5_pdb_samples/sample_*.sdf

# æŸ¥çœ‹ç¬¬ä¸€ä¸ªåˆ†å­çš„ä¿¡æ¯
python -c "
from rdkit import Chem
mol = Chem.MolFromMolFile('outputs/pocket5_pdb_samples/sample_0000.sdf')
if mol:
    print(f'åŽŸå­æ•°: {mol.GetNumAtoms()}')
    print(f'SMILES: {Chem.MolToSmiles(mol)}')
"
```

---

## ðŸš€ å¿«é€Ÿå¯åŠ¨è„šæœ¬

åˆ›å»ºä¸€ä¸ªå¿«é€Ÿå¯åŠ¨è„šæœ¬ï¼š

```bash
cat > sample_pocket5.sh << 'EOF'
#!/bin/bash
# å›ºå®šå£è¢‹ 5 é‡‡æ ·è„šæœ¬

POCKET_ID=5
NUM_SAMPLES=100
DEVICE=cuda:0
RESULT_PATH="./outputs/pocket${POCKET_ID}_samples"

echo "å¼€å§‹é‡‡æ ·å£è¢‹ ${POCKET_ID}ï¼Œç”Ÿæˆ ${NUM_SAMPLES} ä¸ªæ ·æœ¬..."

python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id ${POCKET_ID} \
  --device ${DEVICE} \
  --mode dynamic \
  --result_path ${RESULT_PATH}

echo "é‡‡æ ·å®Œæˆï¼ç»“æžœä¿å­˜åœ¨: ${RESULT_PATH}"
EOF

chmod +x sample_pocket5.sh
./sample_pocket5.sh
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•çŸ¥é“æµ‹è¯•é›†ä¸­æœ‰å¤šå°‘ä¸ªæ ·æœ¬ï¼Ÿ

```bash
python -c "
import torch
from datasets import get_dataset
import utils.transforms as trans
from torch_geometric.transforms import Compose

ckpt = torch.load('pretrained_models/pretrained_diffusion.pt', map_location='cpu')
config = ckpt['config']

protein_featurizer = trans.FeaturizeProteinAtom()
ligand_atom_mode = config.data.transform.ligand_atom_mode
ligand_featurizer = trans.FeaturizeLigandAtom(ligand_atom_mode)
transform = Compose([
    protein_featurizer,
    ligand_featurizer,
    trans.FeaturizeLigandBond(),
])

dataset, subsets = get_dataset(config=config.data, transform=transform)
train_set, test_set = subsets['train'], subsets['test']

print(f'è®­ç»ƒé›†å¤§å°: {len(train_set)}')
print(f'æµ‹è¯•é›†å¤§å°: {len(test_set)}')
print(f'å¯ç”¨ç´¢å¼•èŒƒå›´: 0-{len(test_set)-1}')
"
```

### Q2: å¦‚ä½•æå–æµ‹è¯•é›†ä¸­çš„ PDB æ–‡ä»¶ï¼Ÿ

```bash
python -c "
import torch
from datasets import get_dataset
import utils.transforms as trans
from torch_geometric.transforms import Compose
import shutil

ckpt = torch.load('pretrained_models/pretrained_diffusion.pt', map_location='cpu')
config = ckpt['config']

protein_featurizer = trans.FeaturizeProteinAtom()
ligand_atom_mode = config.data.transform.ligand_atom_mode
ligand_featurizer = trans.FeaturizeLigandAtom(ligand_atom_mode)
transform = Compose([
    protein_featurizer,
    ligand_featurizer,
    trans.FeaturizeLigandBond(),
])

dataset, subsets = get_dataset(config=config.data, transform=transform)
test_set = subsets['test']

# èŽ·å–ç´¢å¼• 5 çš„æ•°æ®
data = test_set[5]
print(f'è›‹ç™½è´¨æ–‡ä»¶: {getattr(data, \"protein_filename\", \"æœªçŸ¥\")}')
print(f'é…ä½“æ–‡ä»¶: {getattr(data, \"ligand_filename\", \"æœªçŸ¥\")}')
"
```

### Q3: å¦‚ä½•æ‰¹é‡é‡‡æ ·å¤šä¸ªå£è¢‹ï¼Ÿ

```bash
# åˆ›å»ºæ‰¹é‡é‡‡æ ·è„šæœ¬
cat > batch_sample_pockets.sh << 'EOF'
#!/bin/bash
# æ‰¹é‡é‡‡æ ·å¤šä¸ªå£è¢‹

POCKETS=(5 10 15 20)
DEVICE=cuda:0

for pocket_id in "${POCKETS[@]}"; do
    echo "æ­£åœ¨é‡‡æ ·å£è¢‹ ${pocket_id}..."
    python scripts/sample_diffusion.py configs/sampling.yml \
      --data_id ${pocket_id} \
      --device ${DEVICE} \
      --mode dynamic \
      --result_path ./outputs/pocket${pocket_id}_samples
    
    if [ $? -eq 0 ]; then
        echo "âœ… å£è¢‹ ${pocket_id} é‡‡æ ·å®Œæˆ"
    else
        echo "âŒ å£è¢‹ ${pocket_id} é‡‡æ ·å¤±è´¥"
    fi
done

echo "æ‰¹é‡é‡‡æ ·å®Œæˆï¼"
EOF

chmod +x batch_sample_pockets.sh
./batch_sample_pockets.sh
```

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- å®Œæ•´å¯åŠ¨æŒ‡å—ï¼š`ç»Ÿä¸€åŠ¨æ€é‡‡æ ·å®Œæ•´å¯åŠ¨æŒ‡å—.md`
- é…ç½®æ–‡ä»¶è¯´æ˜Žï¼š`configs/sampling.yml`
- 16GB æ˜¾å­˜ä¼˜åŒ–ï¼š`16GBæ˜¾å­˜ä¼˜åŒ–è¯´æ˜Ž.md`

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼**

