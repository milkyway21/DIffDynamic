# DiffDynamic ç»Ÿä¸€åŠ¨æ€é‡‡æ ·å®Œæ•´å¯åŠ¨æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨ä»é›¶å¼€å§‹é…ç½®ç¯å¢ƒå¹¶å¯åŠ¨ DiffDynamic çš„ç»Ÿä¸€åŠ¨æ€é‡‡æ ·åŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

1. [WSL ç¯å¢ƒå‡†å¤‡](#1-wsl-ç¯å¢ƒå‡†å¤‡)
2. [ç¯å¢ƒé…ç½®](#2-ç¯å¢ƒé…ç½®)
3. [æ–‡ä»¶å‡†å¤‡æ¸…å•](#3-æ–‡ä»¶å‡†å¤‡æ¸…å•)
4. [é…ç½®æ–‡ä»¶æ£€æŸ¥ä¸ä¿®æ”¹](#4-é…ç½®æ–‡ä»¶æ£€æŸ¥ä¸ä¿®æ”¹)
5. [WSL å¯åŠ¨å‘½ä»¤](#5-wsl-å¯åŠ¨å‘½ä»¤)
6. [éªŒè¯ä¸æµ‹è¯•](#6-éªŒè¯ä¸æµ‹è¯•)
7. [å¸¸è§é—®é¢˜æ’æŸ¥](#7-å¸¸è§é—®é¢˜æ’æŸ¥)

---

## 1. WSL ç¯å¢ƒå‡†å¤‡

### 1.1 å®‰è£… WSLï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰

åœ¨ Windows PowerShellï¼ˆç®¡ç†å‘˜æƒé™ï¼‰ä¸­æ‰§è¡Œï¼š

```powershell
# å®‰è£… WSLï¼ˆé»˜è®¤ Ubuntuï¼‰
wsl --install

# æˆ–æŒ‡å®š Ubuntu ç‰ˆæœ¬
wsl --install -d Ubuntu-22.04
```

å®‰è£…å®Œæˆåé‡å¯è®¡ç®—æœºã€‚

### 1.2 è¿›å…¥ WSL å¹¶æ›´æ–°ç³»ç»Ÿ

```bash
# è¿›å…¥ WSL
wsl

# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y build-essential curl wget git vim
```

### 1.3 å®‰è£… Miniconda/Mambaforge

#### æ–¹å¼ Aï¼šå®‰è£… Minicondaï¼ˆæ¨èï¼‰

```bash
# ä¸‹è½½ Miniconda
cd ~
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# å®‰è£…
bash Miniconda3-latest-Linux-x86_64.sh
# æŒ‰æç¤ºæ“ä½œï¼šå›è½¦é˜…è¯»åè®®ï¼Œè¾“å…¥ yes åŒæ„ï¼Œå›è½¦ç¡®è®¤å®‰è£…è·¯å¾„

# é‡æ–°åŠ è½½ shell é…ç½®
source ~/.bashrc

# éªŒè¯å®‰è£…
conda --version
```

#### æ–¹å¼ Bï¼šå®‰è£… Mambaforgeï¼ˆæ›´å¿«ï¼‰

```bash
# ä¸‹è½½ Mambaforge
cd ~
wget "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh"

# å®‰è£…
bash Mambaforge-$(uname)-$(uname -m).sh
# æŒ‰æç¤ºæ“ä½œ

# é‡æ–°åŠ è½½ shell é…ç½®
source ~/.bashrc

# éªŒè¯å®‰è£…
mamba --version
```

### 1.4 é…ç½® CUDAï¼ˆå¦‚æœä½¿ç”¨ GPUï¼‰

ç¡®ä¿ Windows ä¸Šå·²å®‰è£… NVIDIA é©±åŠ¨ï¼Œç„¶ååœ¨ WSL ä¸­ï¼š

```bash
# æ£€æŸ¥ NVIDIA é©±åŠ¨ï¼ˆåœ¨ Windows PowerShell ä¸­ï¼‰
nvidia-smi

# åœ¨ WSL ä¸­æ£€æŸ¥ CUDA å¯ç”¨æ€§ï¼ˆå®‰è£… PyTorch åï¼‰
python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
```

---

## 2. ç¯å¢ƒé…ç½®

### 2.1 åˆ›å»º Conda ç¯å¢ƒ

#### æ–¹å¼ Aï¼šä½¿ç”¨ Condaï¼ˆæ ‡å‡†æ–¹å¼ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•ï¼ˆå‡è®¾é¡¹ç›®åœ¨ Windows çš„ D:\DiffDynamicï¼ŒWSL ä¸­è·¯å¾„ä¸º /mnt/d/DiffDynamicï¼‰
cd /mnt/d/DiffDynamic

# åˆ›å»ºç¯å¢ƒ
conda create -n targetdiff python=3.8 -y

# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff

# å®‰è£… PyTorchï¼ˆCUDA 11.6ï¼‰
conda install pytorch pytorch-cuda=11.6 -c pytorch -c nvidia -y

# å®‰è£… PyTorch Geometric
conda install pyg -c pyg -y

# å®‰è£…å…¶ä»–ä¾èµ–
conda install rdkit openbabel tensorboard pyyaml easydict python-lmdb -c conda-forge -y

# å®‰è£… Vina ç›¸å…³ï¼ˆç”¨äºå¯¹æ¥è¯„ä¼°ï¼Œå¯é€‰ï¼‰
pip install meeko==0.1.dev3 scipy pdb2pqr vina==1.2.2
python -m pip install git+https://github.com/Valdes-Tresanco-MS/AutoDockTools_py3
```

#### æ–¹å¼ Bï¼šä½¿ç”¨ Mambaï¼ˆæ›´å¿«ï¼Œæ¨èï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /mnt/d/DiffDynamic

# ä½¿ç”¨ environment.yaml åˆ›å»ºç¯å¢ƒ
mamba env create -f environment.yaml

# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff
```

### 2.2 éªŒè¯ç¯å¢ƒå®‰è£…

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff

# éªŒè¯å…³é”®åŒ…
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDAå¯ç”¨: {torch.cuda.is_available()}')"
python -c "import torch_geometric; print(f'PyG: {torch_geometric.__version__}')"
python -c "from rdkit import Chem; print('RDKit: OK')"
python -c "import openbabel; print('OpenBabel: OK')"
```

---

## 3. æ–‡ä»¶å‡†å¤‡æ¸…å•

### 3.1 å¿…éœ€æ–‡ä»¶æ¸…å•

è¯·ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å·²å‡†å¤‡å¹¶æ”¾ç½®åœ¨æ­£ç¡®ä½ç½®ï¼š

#### âœ… é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¿…éœ€ï¼‰

| æ–‡ä»¶å | ä¸‹è½½é“¾æ¥ | æ”¾ç½®ä½ç½® | è¯´æ˜ |
|--------|----------|----------|------|
| `pretrained_diffusion.pt` | [Google Drive](https://drive.google.com/drive/folders/1-ftaIrTXjWFhw3-0Twkrs5m0yX6CNarz?usp=share_link) | `./pretrained_models/pretrained_diffusion.pt` | æ‰©æ•£æ¨¡å‹æƒé‡ |

**æ£€æŸ¥å‘½ä»¤ï¼š**
```bash
ls -lh pretrained_models/pretrained_diffusion.pt
```

#### âœ… æ•°æ®æ–‡ä»¶ï¼ˆå¿…éœ€ï¼Œç”¨äºä»æµ‹è¯•é›†é‡‡æ ·ï¼‰

| æ–‡ä»¶å | ä¸‹è½½é“¾æ¥ | æ”¾ç½®ä½ç½® | è¯´æ˜ |
|--------|----------|----------|------|
| `crossdocked_pocket10_pose_split.pt` | [Google Drive](https://drive.google.com/drive/folders/1j21cc7-97TedKh_El5E34yI8o5ckI7eK?usp=share_link) | `./data/crossdocked_pocket10_pose_split.pt` | æ•°æ®åˆ’åˆ†æ–‡ä»¶ |
| `crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb` | åŒä¸Š | `./data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb` | è®­ç»ƒæ•°æ®ï¼ˆLMDBæ ¼å¼ï¼‰ |

**æ£€æŸ¥å‘½ä»¤ï¼š**
```bash
ls -lh data/crossdocked_pocket10_pose_split.pt
ls -lh data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb
```

#### âœ… é…ç½®æ–‡ä»¶ï¼ˆé¡¹ç›®è‡ªå¸¦ï¼‰

| æ–‡ä»¶å | ä½ç½® | è¯´æ˜ |
|--------|------|------|
| `sampling.yml` | `./configs/sampling.yml` | é‡‡æ ·é…ç½®æ–‡ä»¶ï¼ˆå·²åŒ…å«ç»Ÿä¸€åŠ¨æ€é‡‡æ ·é…ç½®ï¼‰ |

**æ£€æŸ¥å‘½ä»¤ï¼š**
```bash
cat configs/sampling.yml
```

#### âœ… ç¤ºä¾‹æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰

| æ–‡ä»¶å | ä½ç½® | è¯´æ˜ |
|--------|------|------|
| `1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb` | `./examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb` | ç¤ºä¾‹è›‹ç™½å£è¢‹ |

### 3.2 æ–‡ä»¶ç»“æ„æ£€æŸ¥è„šæœ¬

åˆ›å»ºå¹¶è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼š

```bash
# åˆ›å»ºæ£€æŸ¥è„šæœ¬
cat > check_files.sh << 'EOF'
#!/bin/bash
echo "=== æ–‡ä»¶å‡†å¤‡æ£€æŸ¥ ==="

# æ£€æŸ¥é¢„è®­ç»ƒæ¨¡å‹
if [ -f "pretrained_models/pretrained_diffusion.pt" ]; then
    echo "âœ… é¢„è®­ç»ƒæ¨¡å‹å­˜åœ¨"
    ls -lh pretrained_models/pretrained_diffusion.pt
else
    echo "âŒ é¢„è®­ç»ƒæ¨¡å‹ç¼ºå¤±: pretrained_models/pretrained_diffusion.pt"
fi

# æ£€æŸ¥æ•°æ®åˆ’åˆ†æ–‡ä»¶
if [ -f "data/crossdocked_pocket10_pose_split.pt" ]; then
    echo "âœ… æ•°æ®åˆ’åˆ†æ–‡ä»¶å­˜åœ¨"
    ls -lh data/crossdocked_pocket10_pose_split.pt
else
    echo "âŒ æ•°æ®åˆ’åˆ†æ–‡ä»¶ç¼ºå¤±: data/crossdocked_pocket10_pose_split.pt"
fi

# æ£€æŸ¥è®­ç»ƒæ•°æ®
if [ -f "data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb" ]; then
    echo "âœ… è®­ç»ƒæ•°æ®å­˜åœ¨"
    ls -lh data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final.lmdb
else
    echo "âš ï¸  è®­ç»ƒæ•°æ®ç¼ºå¤±ï¼ˆå¦‚æœåªä» PDB æ–‡ä»¶é‡‡æ ·åˆ™ä¸éœ€è¦ï¼‰"
fi

# æ£€æŸ¥é…ç½®æ–‡ä»¶
if [ -f "configs/sampling.yml" ]; then
    echo "âœ… é‡‡æ ·é…ç½®æ–‡ä»¶å­˜åœ¨"
else
    echo "âŒ é‡‡æ ·é…ç½®æ–‡ä»¶ç¼ºå¤±: configs/sampling.yml"
fi

echo "=== æ£€æŸ¥å®Œæˆ ==="
EOF

# è¿è¡Œæ£€æŸ¥
chmod +x check_files.sh
./check_files.sh
```

---

## 4. é…ç½®æ–‡ä»¶æ£€æŸ¥ä¸ä¿®æ”¹

### 4.1 æ£€æŸ¥ `configs/sampling.yml`

ç¡®ä¿é…ç½®æ–‡ä»¶åŒ…å«ç»Ÿä¸€åŠ¨æ€é‡‡æ ·é…ç½®ï¼š

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶
cat configs/sampling.yml
```

**å…³é”®é…ç½®é¡¹ï¼š**

```yaml
sample:
  mode: dynamic  # å¿…é¡»ä¸º dynamic
  dynamic:
    method: auto  # auto ä¼šè‡ªåŠ¨é€‰æ‹© unifiedï¼ˆç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼‰
    # æˆ–æ˜¾å¼æŒ‡å®šï¼š
    # method: unified  # å¼ºåˆ¶ä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·
```

### 4.2 æ˜¾å­˜ä¼˜åŒ–é…ç½®ï¼ˆ16GB æ˜¾å­˜ï¼‰

å¦‚æœæ‚¨çš„ GPU æ˜¾å­˜ä¸º 16GBï¼Œé…ç½®æ–‡ä»¶å·²ä¼˜åŒ–ä¸ºï¼š

```yaml
dynamic:
  large_step:
    batch_size: 16  # å·²ä» 32 é™è‡³ 16
  refine:
    n_sampling: 2  # å·²ä» 3 é™è‡³ 2
  selector:
    top_n: 12  # å·²ä» 16 é™è‡³ 12
```

**å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆ8GB æ˜¾å­˜ï¼‰ï¼š**

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim configs/sampling.yml
```

ä¿®æ”¹ä¸ºï¼š
```yaml
dynamic:
  large_step:
    batch_size: 8  # è¿›ä¸€æ­¥å‡å°
  refine:
    n_sampling: 1  # è¿›ä¸€æ­¥å‡å°
  selector:
    top_n: 6  # è¿›ä¸€æ­¥å‡å°
```

### 4.3 éªŒè¯é…ç½®æ–‡ä»¶

```bash
# ä½¿ç”¨ Python éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
python -c "
import yaml
with open('configs/sampling.yml', 'r') as f:
    config = yaml.safe_load(f)
    print('âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®')
    print(f'é‡‡æ ·æ¨¡å¼: {config[\"sample\"][\"mode\"]}')
    print(f'åŠ¨æ€æ–¹æ³•: {config[\"sample\"][\"dynamic\"][\"method\"]}')
"
```

---

## 5. WSL å¯åŠ¨å‘½ä»¤

### 5.1 åœºæ™¯ Aï¼šä»æµ‹è¯•é›†é‡‡æ ·ï¼ˆä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼‰

```bash
# è¿›å…¥ WSL
wsl

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /mnt/d/DiffDynamic

# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff

# å¯åŠ¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼ˆæµ‹è¯•é›†ç´¢å¼• 0ï¼‰
python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id 0 \
  --device cuda:0 \
  --mode dynamic \
  --result_path ./outputs/unified_dynamic_case0
```

**å‚æ•°è¯´æ˜ï¼š**
- `--data_id 0`: æµ‹è¯•é›†ä¸­ç¬¬ 0 ä¸ªæ ·æœ¬
- `--device cuda:0`: ä½¿ç”¨ GPU 0ï¼ˆå¦‚æœåªæœ‰ CPUï¼Œæ”¹ä¸º `cpu`ï¼‰
- `--mode dynamic`: åŠ¨æ€é‡‡æ ·æ¨¡å¼ï¼ˆä¼šä½¿ç”¨ unified æ–¹æ³•ï¼‰
- `--result_path`: ç»“æœä¿å­˜è·¯å¾„

### 5.2 åœºæ™¯ Bï¼šä» PDB æ–‡ä»¶é‡‡æ ·ï¼ˆä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼‰

```bash
# è¿›å…¥ WSL
wsl

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /mnt/d/DiffDynamic

# æ¿€æ´»ç¯å¢ƒ
conda activate targetdiff

# å¯åŠ¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼ˆä» PDB æ–‡ä»¶ï¼‰
python scripts/sample_for_pocket.py configs/sampling.yml --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb --device cuda:0 --num_samples 100 --result_path ./outputs/unified_dynamic_pdb_sample
```
python scripts/sample_for_pocket.py configs/sampling.yml --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb --device cuda:0 --num_samples 100 --result_path ./outputs/unified_dynamic_pdb_sample
**æ³¨æ„ï¼š** `sample_for_pocket.py` ä¼šæ ¹æ® `configs/sampling.yml` ä¸­çš„ `mode: dynamic` è‡ªåŠ¨ä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ã€‚

### 5.3 åœºæ™¯ Cï¼šæ‰¹é‡é‡‡æ ·ï¼ˆå¤šä¸ªæµ‹è¯•æ ·æœ¬ï¼‰

```bash
# åˆ›å»ºæ‰¹é‡é‡‡æ ·è„šæœ¬
cat > batch_unified_sample.sh << 'EOF'
#!/bin/bash
# æ‰¹é‡é‡‡æ ·è„šæœ¬

CONFIG="configs/sampling.yml"
OUTPUT_DIR="./outputs/batch_unified"
DEVICE="cuda:0"

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p $OUTPUT_DIR

# é‡‡æ ·æµ‹è¯•é›†å‰ 10 ä¸ªæ ·æœ¬
for i in {0..9}; do
    echo "æ­£åœ¨é‡‡æ ·æ ·æœ¬ $i..."
    python scripts/sample_diffusion.py $CONFIG \
      --data_id $i \
      --device $DEVICE \
      --mode dynamic \
      --result_path $OUTPUT_DIR/case_$i
    
    if [ $? -eq 0 ]; then
        echo "âœ… æ ·æœ¬ $i é‡‡æ ·å®Œæˆ"
    else
        echo "âŒ æ ·æœ¬ $i é‡‡æ ·å¤±è´¥"
    fi
done

echo "æ‰¹é‡é‡‡æ ·å®Œæˆï¼"
EOF

# è¿è¡Œæ‰¹é‡é‡‡æ ·
chmod +x batch_unified_sample.sh
./batch_unified_sample.sh
```

### 5.4 åœºæ™¯ Dï¼šå¼ºåˆ¶ä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ï¼ˆæ˜¾å¼æŒ‡å®šï¼‰

å¦‚æœé…ç½®æ–‡ä»¶ä¸­ `method: auto`ï¼Œä½†æ‚¨æƒ³å¼ºåˆ¶ä½¿ç”¨ `unified`ï¼š

```bash
# æ–¹æ³• 1ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶
vim configs/sampling.yml
# å°† method: auto æ”¹ä¸º method: unified

# æ–¹æ³• 2ï¼šä½¿ç”¨ä¸´æ—¶é…ç½®æ–‡ä»¶
cat > configs/sampling_unified.yml << 'EOF'
model:
  checkpoint: ./pretrained_models/pretrained_diffusion.pt

sample:
  seed: 2021
  num_samples: 100
  num_steps: 1000
  pos_only: False
  center_pos_mode: protein
  sample_num_atoms: prior
  mode: dynamic
  dynamic:
    method: unified  # å¼ºåˆ¶ä½¿ç”¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·
    large_step:
      schedule: lambda
      batch_size: 16
      stride: 50
      step_size: 1.0
      n_repeat: 4
      noise_scale: 0.0
      time_lower: 500
    refine:
      schedule: lambda
      stride: 10
      step_size: 0.2
      time_upper: 500
      time_lower: 0
      cycles: 1
      n_sampling: 2
      noise_scale: 0.0
    selector:
      top_n: 12
      min_qed: 0.0
      max_sa: 6.0
      qed_weight: 1.0
      sa_weight: 1.0
EOF

# ä½¿ç”¨ä¸´æ—¶é…ç½®å¯åŠ¨
python scripts/sample_diffusion.py configs/sampling_unified.yml \
  --data_id 0 \
  --device cuda:0 \
  --mode dynamic \
  --result_path ./outputs/unified_explicit
```

---

## 6. éªŒè¯ä¸æµ‹è¯•

### 6.1 è¿è¡Œç¯å¢ƒæ£€æŸ¥è„šæœ¬

```bash
# è¿è¡Œé¡¹ç›®è‡ªå¸¦çš„æ£€æŸ¥è„šæœ¬
python check_requirements.py
```

### 6.2 å¿«é€Ÿæµ‹è¯•é‡‡æ ·åŠŸèƒ½

```bash
# ä½¿ç”¨ç¤ºä¾‹æ–‡ä»¶è¿›è¡Œå¿«é€Ÿæµ‹è¯•
python scripts/sample_for_pocket.py configs/sampling.yml \
  --pdb_path examples/1h36_A_rec_1h36_r88_lig_tt_docked_0_pocket10.pdb \
  --device cuda:0 \
  --num_samples 10 \
  --result_path ./outputs/test_sample

# æ£€æŸ¥è¾“å‡º
ls -lh outputs/test_sample/
```

### 6.3 éªŒè¯é‡‡æ ·ç»“æœ

```bash
# æ£€æŸ¥ç»“æœæ–‡ä»¶
python -c "
import torch
result = torch.load('outputs/test_sample/result_0.pt')
print(f'é‡‡æ ·æ¨¡å¼: {result.get(\"mode\", \"unknown\")}')
print(f'ç”Ÿæˆæ ·æœ¬æ•°: {len(result[\"pred_ligand_pos\"])}')
print(f'è½¨è¿¹æ­¥æ•°: {len(result[\"pred_ligand_pos_traj\"][0]) if result[\"pred_ligand_pos_traj\"] else 0}')
"
```

---

## 7. å¸¸è§é—®é¢˜æ’æŸ¥

### 7.1 CUDA ä¸å¯ç”¨

**é—®é¢˜ï¼š** `torch.cuda.is_available()` è¿”å› `False`

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥ Windows ä¸Šçš„ NVIDIA é©±åŠ¨
# åœ¨ Windows PowerShell ä¸­è¿è¡Œï¼š
nvidia-smi

# 2. æ£€æŸ¥ WSL ä¸­çš„ CUDA æ”¯æŒ
# åœ¨ WSL ä¸­è¿è¡Œï¼š
ls /usr/lib/wsl/lib/ | grep -i cuda

# 3. é‡æ–°å®‰è£… PyTorchï¼ˆåŒ¹é… CUDA ç‰ˆæœ¬ï¼‰
conda activate targetdiff
conda install pytorch pytorch-cuda=11.6 -c pytorch -c nvidia -y

# 4. éªŒè¯
python -c "import torch; print(torch.cuda.is_available())"
```

### 7.2 æ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰

**é—®é¢˜ï¼š** `RuntimeError: CUDA out of memory`

**è§£å†³æ–¹æ¡ˆï¼š**

1. **å‡å°æ‰¹é‡å¤§å°ï¼š**
   ```bash
   # ç¼–è¾‘ configs/sampling.yml
   vim configs/sampling.yml
   ```
   ä¿®æ”¹ï¼š
   ```yaml
   dynamic:
     large_step:
       batch_size: 8  # ä» 16 å‡å°åˆ° 8
     refine:
       n_sampling: 1  # ä» 2 å‡å°åˆ° 1
     selector:
       top_n: 6  # ä» 12 å‡å°åˆ° 6
   ```

2. **ä½¿ç”¨ CPUï¼ˆä¸æ¨èï¼Œå¾ˆæ…¢ï¼‰ï¼š**
   ```bash
   python scripts/sample_diffusion.py configs/sampling.yml \
     --data_id 0 \
     --device cpu \
     --mode dynamic \
     --result_path ./outputs/cpu_sample
   ```

### 7.3 æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶

**é—®é¢˜ï¼š** `FileNotFoundError: data/crossdocked_pocket10_pose_split.pt`

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh data/crossdocked_pocket10_pose_split.pt

# 2. å¦‚æœæ–‡ä»¶åœ¨ Windows è·¯å¾„ï¼Œæ£€æŸ¥ WSL è·¯å¾„æ˜ å°„
# Windows: D:\DiffDynamic\data\...
# WSL: /mnt/d/DiffDynamic/data/...

# 3. å¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
pwd  # åº”è¯¥æ˜¾ç¤º /mnt/d/DiffDynamic
```

### 7.4 æ‰¾ä¸åˆ°é¢„è®­ç»ƒæ¨¡å‹

**é—®é¢˜ï¼š** `FileNotFoundError: pretrained_models/pretrained_diffusion.pt`

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh pretrained_models/pretrained_diffusion.pt

# 2. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„
grep checkpoint configs/sampling.yml

# 3. å¦‚æœè·¯å¾„ä¸å¯¹ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶
vim configs/sampling.yml
# ç¡®ä¿ checkpoint: ./pretrained_models/pretrained_diffusion.pt
```

### 7.5 ç»Ÿä¸€åŠ¨æ€é‡‡æ ·æœªç”Ÿæ•ˆ

**é—®é¢˜ï¼š** é‡‡æ ·ç»“æœä¸­ `mode` ä¸æ˜¯ `dynamic` æˆ–ä½¿ç”¨äº† `legacy` æ–¹æ³•

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥é…ç½®æ–‡ä»¶
cat configs/sampling.yml | grep -A 5 "dynamic:"

# 2. ç¡®ä¿é…ç½®æ­£ç¡®
# mode: dynamic
# method: unified æˆ– method: auto

# 3. æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°
# ç¡®ä¿ä½¿ç”¨äº† --mode dynamicï¼ˆå¦‚æœå‘½ä»¤è¡ŒæŒ‡å®šäº† modeï¼‰

# 4. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
# é‡‡æ ·æ—¶ä¼šæ‰“å°ä½¿ç”¨çš„é‡‡æ ·æ–¹æ³•
```

### 7.6 WSL è·¯å¾„é—®é¢˜

**é—®é¢˜ï¼š** Windows è·¯å¾„åœ¨ WSL ä¸­æ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# Windows è·¯å¾„æ˜ å°„è§„åˆ™ï¼š
# C:\Users\... -> /mnt/c/Users/...
# D:\DiffDynamic -> /mnt/d/DiffDynamic

# æ£€æŸ¥è·¯å¾„
ls /mnt/d/DiffDynamic

# å¦‚æœæ— æ³•è®¿é—®ï¼Œå¯èƒ½éœ€è¦é‡æ–°æŒ‚è½½
sudo mount -t drvfs D: /mnt/d
```

---

## 8. å®Œæ•´å¯åŠ¨æµç¨‹æ€»ç»“

### ä¸€é”®å¯åŠ¨è„šæœ¬

åˆ›å»ºå®Œæ•´çš„å¯åŠ¨è„šæœ¬ï¼š

```bash
cat > start_unified_sampling.sh << 'EOF'
#!/bin/bash
# DiffDynamic ç»Ÿä¸€åŠ¨æ€é‡‡æ ·ä¸€é”®å¯åŠ¨è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "=== DiffDynamic ç»Ÿä¸€åŠ¨æ€é‡‡æ ·å¯åŠ¨è„šæœ¬ ==="

# 1. æ£€æŸ¥ç¯å¢ƒ
echo "[1/5] æ£€æŸ¥ Conda ç¯å¢ƒ..."
if ! command -v conda &> /dev/null; then
    echo "âŒ Conda æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Miniconda æˆ– Mambaforge"
    exit 1
fi

# 2. æ¿€æ´»ç¯å¢ƒ
echo "[2/5] æ¿€æ´» Conda ç¯å¢ƒ..."
source $(conda info --base)/etc/profile.d/conda.sh
conda activate targetdiff || {
    echo "âŒ ç¯å¢ƒ targetdiff ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºç¯å¢ƒ"
    exit 1
}

# 3. æ£€æŸ¥æ–‡ä»¶
echo "[3/5] æ£€æŸ¥å¿…éœ€æ–‡ä»¶..."
missing_files=0

if [ ! -f "pretrained_models/pretrained_diffusion.pt" ]; then
    echo "âŒ é¢„è®­ç»ƒæ¨¡å‹ç¼ºå¤±: pretrained_models/pretrained_diffusion.pt"
    missing_files=1
fi

if [ ! -f "data/crossdocked_pocket10_pose_split.pt" ]; then
    echo "âŒ æ•°æ®åˆ’åˆ†æ–‡ä»¶ç¼ºå¤±: data/crossdocked_pocket10_pose_split.pt"
    missing_files=1
fi

if [ ! -f "configs/sampling.yml" ]; then
    echo "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±: configs/sampling.yml"
    missing_files=1
fi

if [ $missing_files -eq 1 ]; then
    echo "è¯·å…ˆå‡†å¤‡ç¼ºå¤±çš„æ–‡ä»¶ï¼Œç„¶åé‡æ–°è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# 4. æ£€æŸ¥ CUDA
echo "[4/5] æ£€æŸ¥ CUDA..."
python -c "import torch; assert torch.cuda.is_available(), 'CUDA ä¸å¯ç”¨'; print(f'âœ… CUDA å¯ç”¨ï¼Œè®¾å¤‡æ•°é‡: {torch.cuda.device_count()}')" || {
    echo "âš ï¸  CUDA ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨ CPUï¼ˆä¼šå¾ˆæ…¢ï¼‰"
    DEVICE="cpu"
}

DEVICE=${DEVICE:-"cuda:0"}

# 5. å¯åŠ¨é‡‡æ ·
echo "[5/5] å¯åŠ¨ç»Ÿä¸€åŠ¨æ€é‡‡æ ·..."
echo "ä½¿ç”¨è®¾å¤‡: $DEVICE"
echo "é…ç½®æ–‡ä»¶: configs/sampling.yml"

# é»˜è®¤å‚æ•°
DATA_ID=${1:-0}
RESULT_PATH=${2:-"./outputs/unified_dynamic_case${DATA_ID}"}

python scripts/sample_diffusion.py configs/sampling.yml \
  --data_id $DATA_ID \
  --device $DEVICE \
  --mode dynamic \
  --result_path $RESULT_PATH

echo "âœ… é‡‡æ ·å®Œæˆï¼ç»“æœä¿å­˜åœ¨: $RESULT_PATH"
EOF

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x start_unified_sampling.sh

# è¿è¡Œè„šæœ¬
./start_unified_sampling.sh
```

**ä½¿ç”¨æ–¹æ³•ï¼š**

```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆdata_id=0ï¼‰
./start_unified_sampling.sh

# æŒ‡å®šæµ‹è¯•é›†ç´¢å¼•
./start_unified_sampling.sh 5

# æŒ‡å®šæµ‹è¯•é›†ç´¢å¼•å’Œè¾“å‡ºè·¯å¾„
./start_unified_sampling.sh 5 ./outputs/my_result
```

---

## 9. è¾“å‡ºç»“æœè¯´æ˜

é‡‡æ ·å®Œæˆåï¼Œç»“æœä¿å­˜åœ¨æŒ‡å®šçš„ `result_path` ç›®å½•ä¸­ï¼š

```
outputs/unified_dynamic_case0/
â”œâ”€â”€ sample.yml              # é‡‡æ ·é…ç½®å¤‡ä»½
â”œâ”€â”€ result_0.pt            # é‡‡æ ·ç»“æœï¼ˆPyTorch æ ¼å¼ï¼‰
â””â”€â”€ ...                    # å…¶ä»–è¾“å‡ºæ–‡ä»¶
```

**ç»“æœæ–‡ä»¶å†…å®¹ï¼š**

- `pred_ligand_pos`: ç”Ÿæˆçš„é…ä½“åæ ‡åˆ—è¡¨
- `pred_ligand_v`: ç”Ÿæˆçš„é…ä½“åŸå­ç±»å‹åˆ—è¡¨
- `pred_ligand_pos_traj`: ä½ç½®è½¨è¿¹
- `pred_ligand_v_traj`: åŸå­ç±»å‹è½¨è¿¹
- `time`: é‡‡æ ·è€—æ—¶åˆ—è¡¨
- `meta`: å…ƒæ•°æ®ï¼ˆåŒ…å«å€™é€‰ç­›é€‰ä¿¡æ¯ï¼‰
- `mode`: é‡‡æ ·æ¨¡å¼ï¼ˆåº”ä¸º `dynamic`ï¼‰

---

## 10. ä¸‹ä¸€æ­¥

é‡‡æ ·å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š

1. **è¯„ä¼°é‡‡æ ·ç»“æœï¼š**
   ```bash
   python scripts/evaluate_diffusion.py ./outputs/unified_dynamic_case0 \
     --docking_mode vina_score \
     --protein_root data/test_set
   ```

2. **å¯è§†åŒ–ç»“æœï¼š** ä½¿ç”¨ Jupyter Notebook åˆ†æç»“æœ

3. **æ‰¹é‡é‡‡æ ·ï¼š** ä½¿ç”¨æ‰¹é‡è„šæœ¬å¤„ç†å¤šä¸ªæ ·æœ¬

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- é¡¹ç›® README: `README.md`
- å¿«é€Ÿå¼€å§‹æŒ‡å—: `å¿«é€Ÿå¼€å§‹.md`
- è¿è¡Œå‡†å¤‡æ¸…å•: `è¿è¡Œå‡†å¤‡æ¸…å•.md`
- 16GB æ˜¾å­˜ä¼˜åŒ–è¯´æ˜: `16GBæ˜¾å­˜ä¼˜åŒ–è¯´æ˜.md`
- åŠ¨æ€è·³æ­¥ç”Ÿæˆæ¨¡å‹é€‰æ‹©å»ºè®®: `åŠ¨æ€è·³æ­¥ç”Ÿæˆæ¨¡å‹é€‰æ‹©å»ºè®®.md`

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå¸¸è§é—®é¢˜æ’æŸ¥éƒ¨åˆ†æˆ–æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ã€‚**

